<mxfile host="Electron" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/26.0.9 Chrome/128.0.6613.186 Electron/32.2.5 Safari/537.36" version="26.0.9">
  <diagram name="Pagina-1" id="3eC-6GflDYz3U1tsH0RZ">
    <mxGraphModel dx="954" dy="727" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="irP9ipBaVc85gEX89IVE-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="wefxeZgxiuNRXq0VxbFX-1" target="irP9ipBaVc85gEX89IVE-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="wefxeZgxiuNRXq0VxbFX-1" value="Messager&lt;br&gt;invoke" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="140" y="250" width="110" height="60" as="geometry" />
        </mxCell>
        <mxCell id="irP9ipBaVc85gEX89IVE-1" value="&lt;div style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;color: rgb(0, 0, 255);&quot;&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;public static &lt;/span&gt;Result &lt;span style=&quot;color: rgb(0, 98, 122);&quot;&gt;invokeOnBefore&lt;/span&gt;(&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Object&lt;/span&gt;[] &lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;argumentArray&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;业务方法入参列表&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;listenerId&lt;/span&gt;,&lt;br&gt;                                    &lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;String listenerClass&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;只是为了排查时更加方便&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;所以在字节码增强时将注入的&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt; listener &lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;类名也写到字节码中&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;listenerTag&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//listener&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;标志，比如仅处理业务流量或仅处理压测流量&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final int &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;executionTag&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;执行标记，&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt; 1 &lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;忽略本次执行&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;  -1 &lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;执行&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Class clazz&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;业务&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;class DruidDataSource.class&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;String javaMethodName&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;业务方法名&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt; getConnection&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;String javaMethodDesc&lt;/span&gt;, &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;业务&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;Class&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;描述&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt; (J)Lcom/alibaba/druid/pool/DruidPooledConnection&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;                                    &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;final &lt;/span&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Object target&lt;/span&gt;) &lt;span style=&quot;font-style: italic; color: rgb(140, 140, 140);&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;font-style: italic; font-family: Menlo-Regular, monospace; color: rgb(140, 140, 140);&quot;&gt;业务对象&lt;/span&gt;&lt;/font&gt;&lt;/pre&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="130" y="60" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="irP9ipBaVc85gEX89IVE-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="1" source="irP9ipBaVc85gEX89IVE-2" target="irP9ipBaVc85gEX89IVE-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="irP9ipBaVc85gEX89IVE-2" value="EventListenerHandler" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="350" y="250" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="irP9ipBaVc85gEX89IVE-3" target="4Iyd2BfPtw3VTpzIcHyr-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="irP9ipBaVc85gEX89IVE-3" value="LazyEventListenerProxy" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="350" y="390" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;dashed=1;" parent="1" source="4Iyd2BfPtw3VTpzIcHyr-2" target="4Iyd2BfPtw3VTpzIcHyr-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-8" value="invoke&amp;nbsp;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="4Iyd2BfPtw3VTpzIcHyr-6" vertex="1" connectable="0">
          <mxGeometry x="-0.1" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-2" value="CoreModule&lt;br&gt;getClassLoader(bizClassLoader)" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="312" y="510" width="216" height="60" as="geometry" />
        </mxCell>
        <mxCell id="W3cCAw4pV4KkjfqYXAFN-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="4Iyd2BfPtw3VTpzIcHyr-4" target="W3cCAw4pV4KkjfqYXAFN-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-4" value="AdviceListener" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="360" y="670" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="4Iyd2BfPtw3VTpzIcHyr-5" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 255), rgb(0, 0, 255)); background-color: transparent;&quot;&gt;业务类加载器与模块类加载器&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 255), rgb(0, 0, 255)); background-color: transparent;&quot;&gt;ModuleClassLoader一对一 ,确保调用模块不会出现ClassNotFound&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="580" y="500" width="600" height="50" as="geometry" />
        </mxCell>
        <mxCell id="W3cCAw4pV4KkjfqYXAFN-1" value="ProcessControlEntity" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="140" y="670" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="W3cCAw4pV4KkjfqYXAFN-3" value="&lt;div style=&quot;color: rgb(8, 8, 8);&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;/**&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt; * &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt;立即返回&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;*/&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;public final static int &lt;/span&gt;&lt;span style=&quot;color: rgb(135, 16, 148); font-style: italic;&quot;&gt;RETURN_IMMEDIATELY &lt;/span&gt;= &lt;span style=&quot;color: rgb(23, 80, 235);&quot;&gt;1&lt;/span&gt;;&lt;br&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;/**&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt; * &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt;立即抛出异常&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;*/&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;public final static int &lt;/span&gt;&lt;span style=&quot;color: rgb(135, 16, 148); font-style: italic;&quot;&gt;THROWS_IMMEDIATELY &lt;/span&gt;= &lt;span style=&quot;color: rgb(23, 80, 235);&quot;&gt;2&lt;/span&gt;;&lt;br&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;/**&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt; * &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt;不干预任何流程&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic; font-family: Menlo-Regular, monospace;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: rgb(140, 140, 140); font-style: italic;&quot;&gt;*/&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: rgb(0, 51, 179);&quot;&gt;public final static int &lt;/span&gt;&lt;span style=&quot;color: rgb(135, 16, 148); font-style: italic;&quot;&gt;NONE_IMMEDIATELY &lt;/span&gt;= &lt;span style=&quot;color: rgb(23, 80, 235);&quot;&gt;3&lt;/span&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="140" y="860" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="W3cCAw4pV4KkjfqYXAFN-4" value="&lt;div style=&quot;background-color: rgb(255, 255, 255);&quot;&gt;&lt;pre style=&quot;font-family: &amp;quot;JetBrains Mono&amp;quot;, monospace; font-size: 9.8pt;&quot;&gt;&lt;font style=&quot;color: rgb(0, 0, 255);&quot;&gt;protected Class&amp;lt;?&amp;gt; internalLoadClass(String name, boolean resolve)&lt;br&gt;        throws ClassNotFoundException {&lt;br&gt;    Class&amp;lt;?&amp;gt; clazz = null;&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 1. find routing&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveRouting(name, resolve);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 2. Import class export by other plugins&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveExportClass(name);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 3. module classpath class&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveLocalClass(name, resolve);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 4. load class from business classloader&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveBusinessClassLoader(name);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 4.1 load class from out business classloader&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveBusinessClassLoaderOuter(name);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    &lt;span style=&quot;font-style: italic;&quot;&gt;// 5. load class from super&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: italic;&quot;&gt;    &lt;/span&gt;if (clazz == null) {&lt;br&gt;        clazz = resolveSystemClass(name, resolve);&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    if (clazz != null) {&lt;br&gt;        if (resolve) {&lt;br&gt;            resolveClass(clazz);&lt;br&gt;        }&lt;br&gt;        return clazz;&lt;br&gt;    }&lt;br&gt;&lt;br&gt;    throw new ClassNotFoundException(&quot;class &quot; + name + &quot; not found in module: &quot; + moduleId);&lt;br&gt;}&lt;/font&gt;&lt;/pre&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="630" y="880" width="60" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
